<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepal Millipede Species Checklist with Map</title>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Link to your main style.css -->
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Page-specific styles that complement style.css */
        :root {
            --primary-green: #2e7d32;
            --light-bg: #f5f5f5;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
            background: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: var(--primary-green);
            text-align: center;
            margin: 30px 0;
            font-size: 2.5rem;
            font-family: 'Times New Roman', Times, serif;
            animation: fadeInDown 0.8s ease-out;
        }

        .search-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
            padding: 0 20px;
            animation: fadeIn 1s ease-out;
        }

        .filter-select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--primary-green);
            min-width: 150px;
            cursor: pointer;
            background: white;
            font-size: 14px;
            font-family: 'Times New Roman', Times, serif;
            transition: all 0.3s ease;
        }

        .filter-select:hover {
            border-color: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .filter-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        .clear-filters-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background: var(--primary-green);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
        }

        .clear-filters-btn:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #resultsCount {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--primary-green);
            font-size: 1.2rem;
            font-family: 'Times New Roman', Times, serif;
            animation: fadeIn 1.2s ease-out;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            gap: 5px;
        }

        .map-toggle-btn {
            padding: 5px 10px;
            border: 2px solid var(--primary-green);
            background: white;
            color: var(--primary-green);
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-family: 'Times New Roman', Times, serif;
        }

        .map-toggle-btn.active {
            background: var(--primary-green);
            color: white;
        }

        .map-toggle-btn:hover {
            background: var(--primary-green);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            padding: 0 20px;
            flex: 1;
        }

        .map-container {
            position: relative;
        }

        #map {
            height: 750px;
            width: 100%;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            border: 2px solid var(--primary-green);
            position: sticky;
            top: 20px;
            z-index: 1;
            transition: all 0.3s ease;
            animation: fadeInRight 1s ease-out;
        }

        #map:hover {
            border-color: var(--gold);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .results-container {
            max-height: 750px;
            overflow-y: auto;
            padding-right: 10px;
            animation: fadeInLeft 1s ease-out;
        }

        /* Custom scrollbar */
        .results-container::-webkit-scrollbar {
            width: 8px;
        }

        .results-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .results-container::-webkit-scrollbar-thumb {
            background: var(--primary-green);
            border-radius: 10px;
        }

        .results-container::-webkit-scrollbar-thumb:hover {
            background: #1b5e20;
        }

        .species-card {
            background: var(--light-bg);
            border-left: 4px solid var(--primary-green);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            font-family: 'Times New Roman', Times, serif;
            animation: fadeInUp 0.5s ease-out;
        }

        .species-card:hover {
            transform: translateY(-5px) translateX(5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            border-left-width: 8px;
            border-left-color: var(--gold);
        }

        .species-card.active {
            background: #e8f5e9;
            border-left-color: #1b5e20;
            border-left-width: 8px;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .taxa-path {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Times New Roman', Times, serif;
        }

        .species-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1b5e20;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            font-family: 'Times New Roman', Times, serif;
        }

        .species-name i {
            font-style: italic;
        }

        .detail-label {
            font-weight: bold;
            color: var(--primary-green);
            display: inline-block;
            min-width: 120px;
            font-family: 'Times New Roman', Times, serif;
        }

        .detail-row {
            margin: 8px 0;
            line-height: 1.4;
            font-family: 'Times New Roman', Times, serif;
            font-size: 1.1rem;
        }

        .coordinates-badge {
            background: #fff;
            border: 1px solid var(--primary-green);
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.9em;
            color: var(--primary-green);
            display: inline-block;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-family: 'Times New Roman', Times, serif;
        }

        .coordinates-badge:hover {
            background: var(--primary-green);
            color: white;
            transform: scale(1.05);
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
            font-size: 1.2rem;
            font-family: 'Times New Roman', Times, serif;
        }

        .leaflet-popup-content {
            font-family: 'Times New Roman', Times, serif;
            min-width: 200px;
            font-size: 14px;
        }

        .leaflet-popup-content strong {
            color: var(--primary-green);
        }

        /* Style for Nepali text if any appears in future */
        .nepali-text {
            font-family: 'Preeti', 'Times New Roman', Times, serif;
            font-size: 1.3rem;
            line-height: 2;
        }

        /* Animation keyframes (if not in style.css) */
        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                padding: 0 15px;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
                margin: 20px 0;
            }

            .main-content {
                grid-template-columns: 1fr;
                padding: 0 15px;
            }
            
            #map {
                height: 400px;
                position: relative;
                top: 0;
            }

            .search-container {
                padding: 0 15px;
            }

            .filter-select {
                min-width: 120px;
                font-size: 13px;
            }

            .species-card {
                padding: 15px;
            }

            .species-name {
                font-size: 1.2rem;
            }

            .detail-row {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .filter-select {
                min-width: 100%;
            }

            .search-container {
                flex-direction: column;
            }

            .clear-filters-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header from style.css will be visible -->
    <header>
        <h1>Millipedes of Nepal</h1>
        <p>All about Nepalese Millipedes</p>
    </header>

    <nav>
        <a href="index.html">Home</a>
        <a href="history.html">History</a>
        <a href="checklist.html">Checklist</a>
        <a href="distribution.html">Distribution</a>
        <a href="articles.html">Articles</a>
        <a href="team.html">Team</a>
        <a href="gallery.html">Gallery</a> 
        <a href="upload.html">Upload</a>
        <a href="faq.html">FAQ</a>
    </nav>

    <h1>Nepalese Millipede Species Checklist</h1>
    
    <div class="search-container">
        <select id="orderFilter" class="filter-select">
            <option value="all">Select Order</option>
        </select>
        <select id="familyFilter" class="filter-select">
            <option value="all">Select Family</option>
        </select>
        <select id="genusFilter" class="filter-select">
            <option value="all">Select Genus</option>
        </select>
        <select id="speciesFilter" class="filter-select">
            <option value="all">Select Species</option>
        </select>
        <button class="clear-filters-btn" onclick="clearAllFilters()">Clear Filters</button>
    </div>

    <div id="resultsCount">Loading species data...</div>
    
    <div class="main-content">
        <div class="results-container" id="checklistResults">
            <!-- Results will be populated here -->
        </div>
        
        <div class="map-container">
            <div class="map-controls">
                <button id="streetBtn" class="map-toggle-btn active" onclick="toggleMapLayer('street')">Street</button>
                <button id="satelliteBtn" class="map-toggle-btn" onclick="toggleMapLayer('satellite')">Satellite</button>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Include your GPS data -->
    <script src="data.js"></script>
    
    <footer>
        <p>Questions? Contact <a href="mailto:lokendrachand56@gmail.com">lokendrachand56@gmail.com</a></p>
        <p>Â© 2026 Lokendra Chand | ðŸ“ž +977-9809733313 / +817090238470</p>
    </footer>
    
    <script>
    // Full species data from checklist.json
    let speciesData = [];
    let map = null;
    let markers = [];
    let currentActiveCard = null;
    
    // Map layers
    let streetLayer = null;
    let satelliteLayer = null;
    let currentLayer = 'street';

    // Initialize map with both street and satellite layers
    function initMap() {
        map = L.map('map').setView([28.3949, 84.1240], 7); // Center on Nepal
        
        // Street layer (OpenStreetMap)
        streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });
        
        // Satellite layer (Esri World Imagery)
        satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 18
        });
        
        // Start with street view
        streetLayer.addTo(map);
    }

    // Toggle between street and satellite view
    function toggleMapLayer(layer) {
        if (layer === currentLayer) return;
        
        // Remove current layer
        if (currentLayer === 'street') {
            map.removeLayer(streetLayer);
        } else {
            map.removeLayer(satelliteLayer);
        }
        
        // Update button states
        document.getElementById('streetBtn').classList.remove('active');
        document.getElementById('satelliteBtn').classList.remove('active');
        
        // Add new layer
        if (layer === 'street') {
            streetLayer.addTo(map);
            document.getElementById('streetBtn').classList.add('active');
            currentLayer = 'street';
        } else {
            satelliteLayer.addTo(map);
            document.getElementById('satelliteBtn').classList.add('active');
            currentLayer = 'satellite';
        }
        
        // Re-add markers if any exist
        if (markers.length > 0) {
            markers.forEach(marker => marker.addTo(map));
        }
    }

    // Clear all markers from map
    function clearMarkers() {
        if (markers.length > 0) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }
    }

    // Add markers for selected species
    function addMarkersForSpecies(order, family, genus, species) {
        clearMarkers();
        
        // Check if millipedePoints is available (from data.js)
        if (typeof millipedePoints === 'undefined') {
            console.error('millipedePoints not found. Make sure data.js is loaded correctly.');
            return;
        }
        
        const filteredPoints = millipedePoints.filter(point => 
            (order === 'all' || point.order === order) &&
            (family === 'all' || point.family === family) &&
            (genus === 'all' || point.genus === genus) &&
            (species === 'all' || point.species === species)
        );

        console.log('Filtered points:', filteredPoints.length); // Debug log

        if (filteredPoints.length === 0) {
            return;
        }

        // Create bounds to fit all markers
        const bounds = [];
        
        filteredPoints.forEach(point => {
            if (point.lat && point.lon) {
                const marker = L.marker([point.lat, point.lon]).addTo(map);
                
                // Create popup with species info
                const popupContent = `
                    <strong>${point.genus} ${point.species}</strong><br>
                    <em>${point.family}</em><br>
                    <small>Lat: ${point.lat.toFixed(4)}<br>Lon: ${point.lon.toFixed(4)}</small>
                `;
                
                marker.bindPopup(popupContent);
                
                marker.on('click', () => {
                    // Highlight corresponding card if it exists
                    const cardId = `${point.genus}_${point.species}`.replace(/\s+/g, '-').toLowerCase();
                    const card = document.getElementById(cardId);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        if (currentActiveCard) {
                            currentActiveCard.classList.remove('active');
                        }
                        card.classList.add('active');
                        currentActiveCard = card;
                    }
                });
                
                markers.push(marker);
                bounds.push([point.lat, point.lon]);
            }
        });

        // Fit map to show all markers
        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // Load Data
    fetch('checklist.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load checklist.json');
            }
            return response.json();
        })
        .then(data => {
            speciesData = data;
            console.log('Species data loaded:', speciesData.length); // Debug log
            initFilters();
            initMap();
            document.getElementById('resultsCount').innerText = `Total: ${speciesData.length} species`;
            displayResults(speciesData); // Show all initially
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('checklistResults').innerHTML = 
                '<div class="no-data">Error loading species data. Please try again.</div>';
            initMap(); // Still initialize map
        });

    function initFilters() {
        populateDropdown('orderFilter', 'order');
        setupListeners();
    }

    function populateDropdown(id, key, filterKey = null, filterValue = null) {
        const select = document.getElementById(id);
        const currentValue = select.value;
        
        let filtered = speciesData;
        if (filterKey && filterValue && filterValue !== 'all') {
            filtered = speciesData.filter(item => item[filterKey] === filterValue);
        }

        const uniqueVals = [...new Set(filtered.map(item => item[key]))]
            .filter(val => val && val !== 'null' && val !== 'undefined')
            .sort();

        select.innerHTML = `<option value="all">Select ${key.charAt(0).toUpperCase() + key.slice(1)}</option>`;
        
        uniqueVals.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            select.appendChild(opt);
        });

        // Restore previous selection if it exists in new options
        if (currentValue && currentValue !== 'all' && uniqueVals.includes(currentValue)) {
            select.value = currentValue;
        }
    }

    function setupListeners() {
        const orderSel = document.getElementById('orderFilter');
        const familySel = document.getElementById('familyFilter');
        const genusSel = document.getElementById('genusFilter');
        const speciesSel = document.getElementById('speciesFilter');

        orderSel.onchange = () => {
            familySel.innerHTML = '<option value="all">Select Family</option>';
            genusSel.innerHTML = '<option value="all">Select Genus</option>';
            speciesSel.innerHTML = '<option value="all">Select Species</option>';
            
            if (orderSel.value !== 'all') {
                populateDropdown('familyFilter', 'family', 'order', orderSel.value);
            }
            updateResults();
        };

        familySel.onchange = () => {
            genusSel.innerHTML = '<option value="all">Select Genus</option>';
            speciesSel.innerHTML = '<option value="all">Select Species</option>';
            
            if (familySel.value !== 'all') {
                populateDropdown('genusFilter', 'genus', 'family', familySel.value);
            }
            updateResults();
        };

        genusSel.onchange = () => {
            speciesSel.innerHTML = '<option value="all">Select Species</option>';
            
            if (genusSel.value !== 'all') {
                populateDropdown('speciesFilter', 'species', 'genus', genusSel.value);
            }
            updateResults();
        };

        speciesSel.onchange = updateResults;
    }

    function updateResults() {
        const order = document.getElementById('orderFilter').value;
        const family = document.getElementById('familyFilter').value;
        const genus = document.getElementById('genusFilter').value;
        const species = document.getElementById('speciesFilter').value;

        const filtered = speciesData.filter(item => 
            (order === 'all' || item.order === order) &&
            (family === 'all' || item.family === family) &&
            (genus === 'all' || item.genus === genus) &&
            (species === 'all' || item.species === species)
        );

        displayResults(filtered);
        
        // Update map with filtered species points
        addMarkersForSpecies(order, family, genus, species);
        
        // Update filter status text
        const filterStatus = [];
        if (order !== 'all') filterStatus.push(order);
        if (family !== 'all') filterStatus.push(family);
        if (genus !== 'all') filterStatus.push(genus);
        if (species !== 'all') filterStatus.push(species);
        
        const statusText = filterStatus.length > 0 
            ? `Showing ${filtered.length} species matching: ${filterStatus.join(' > ')}`
            : `Showing all ${filtered.length} species`;
            
        document.getElementById('resultsCount').innerText = statusText;
    }

    function displayResults(results) {
        const container = document.getElementById('checklistResults');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = '<div class="no-data">No species found matching those criteria.</div>';
            return;
        }

        results.forEach(item => {
            // Find GPS points for this species from millipedePoints
            let speciesPoints = [];
            if (typeof millipedePoints !== 'undefined') {
                speciesPoints = millipedePoints.filter(p => 
                    p.order === item.order && 
                    p.family === item.family && 
                    p.genus === item.genus && 
                    p.species === item.species
                ).filter(p => p.lat && p.lon);
            }

            const hasCoordinates = speciesPoints.length > 0;
            const cardId = `${item.genus}_${item.species}`.replace(/\s+/g, '-').toLowerCase();

            const card = document.createElement('div');
            card.className = 'species-card';
            card.id = cardId;
            
            // Create coordinates display
            let coordsHtml = '';
            if (hasCoordinates) {
                coordsHtml = `<div class="coordinates-badge">ðŸ“ ${speciesPoints.length} location${speciesPoints.length > 1 ? 's' : ''} on map</div>`;
            }

            card.innerHTML = `
                <div class="taxa-path">${item.order || 'N/A'} > ${item.family || 'N/A'}</div>
                <div class="species-name"><i>${item.genus || '?'} ${item.species || '?'}</i> ${item.author || ''}</div>
                <div class="detail-row"><span class="detail-label">Type Locality:</span> ${item.type_locality || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Global Distribution:</span> ${item.global_dist || 'N/A'}</div>
                <div class="detail-row"><span class="detail-label">Nepal Distribution:</span> ${item.nepal_dist || 'N/A'}</div>
                ${coordsHtml}
            `;

            // Add click handler to show on map
            card.onclick = () => {
                if (hasCoordinates && typeof millipedePoints !== 'undefined') {
                    // Clear previous active state
                    if (currentActiveCard) {
                        currentActiveCard.classList.remove('active');
                    }
                    card.classList.add('active');
                    currentActiveCard = card;
                    
                    // Show these points on map
                    clearMarkers();
                    
                    speciesPoints.forEach(point => {
                        const marker = L.marker([point.lat, point.lon]).addTo(map);
                        marker.bindPopup(`
                            <strong>${point.genus} ${point.species}</strong><br>
                            <em>${point.family}</em><br>
                            <small>Lat: ${point.lat.toFixed(4)}<br>Lon: ${point.lon.toFixed(4)}</small>
                        `);
                        markers.push(marker);
                    });
                    
                    // Fit map to show all points for this species
                    if (speciesPoints.length > 0) {
                        const bounds = speciesPoints.map(p => [p.lat, p.lon]);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }
            };

            container.appendChild(card);
        });
    }

    function clearAllFilters() {
        document.getElementById('orderFilter').value = 'all';
        document.getElementById('familyFilter').innerHTML = '<option value="all">Select Family</option>';
        document.getElementById('genusFilter').innerHTML = '<option value="all">Select Genus</option>';
        document.getElementById('speciesFilter').innerHTML = '<option value="all">Select Species</option>';
        
        // Repopulate family based on 'all' orders
        if (speciesData.length > 0) {
            populateDropdown('familyFilter', 'family');
        }
        
        updateResults();
    }

    // Make functions available globally
    window.clearAllFilters = clearAllFilters;
    window.toggleMapLayer = toggleMapLayer;
    </script>
</body>
</html>
